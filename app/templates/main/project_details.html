{% extends "base.html" %}

{% block content %}
    <h1 class="my-4">{{ project.name }}</h1>
    
    <div class="row">
        <div class="col-md-8">  <!-- Left column for documents and assessments -->
            <div class="card mb-3">  <!-- Documents card -->
                <div class="card-body">
                    <h5 class="card-title">Documents</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Uploaded Documents</h6>
                    <ul class="list-unstyled">
                        {% for document in project.documents %}
                            <li class="mb-2">
                                {% set file_ext = document.filename.split('.')[-1]|lower %}
                                {% if file_ext == 'pdf' %}
                                    <i class="fas fa-file-pdf text-danger"></i>
                                {% elif file_ext in ['doc', 'docx'] %}
                                    <i class="fas fa-file-word text-primary"></i>
                                {% elif file_ext == 'txt' %}
                                    <i class="fas fa-file-alt text-secondary"></i>
                                {% else %}
                                    <i class="fas fa-file text-secondary"></i>
                                {% endif %}
                                <span class="ml-2">{{ document.filename }}</span>
                                <span class="text-muted">({{ document.document_type|replace('_', ' ')|title }})</span>
                                <form action="{{ url_for('main.delete_document', project_id=project.id, document_id=document.id) }}" 
                                      method="POST" style="display:inline;" id="deleteForm-{{ document.id }}">
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="showDeleteConfirmation('{{ document.filename }}', {{ document.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </li>
                        {% else %}
                            <li><i class="fas fa-info-circle text-info"></i> No documents uploaded yet.</li>
                        {% endfor %}
                    </ul>
                    <a href="{{ url_for('main.upload_document', project_id=project.id) }}" class="btn btn-primary">Upload Document</a>
                </div>
            </div>

            <div class="card mb-3">  <!-- Assessments card -->
                <div class="card-body">
                    <h5 class="card-title">Assessments</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Previous Assessment Runs</h6>
                    <ul class="list-unstyled">
                        {% for evaluation in project.evaluation_runs|sort(attribute='created_at', reverse=True) %}
                            <li class="mb-3">  <!-- Increased margin bottom -->
                                <div class="d-flex justify-content-between align-items-center">  <!-- Flex container -->
                                    <div>  <!-- Left side with date and model info -->
                                        {% set adjusted_time = evaluation.created_at.replace(
                                            hour=(evaluation.created_at.hour - 4) % 24,
                                            day=evaluation.created_at.day - 1 if evaluation.created_at.hour < 4 else evaluation.created_at.day
                                        ) %}
                                        {{ adjusted_time.strftime('%b %d, %Y %H:%M') }} EDT
                                        using {{ evaluation.model_used|replace('claude-', 'Claude ')|replace('-latest', '')|replace('-', '.')|title }}
                                        ({{ evaluation.responses|length }} questions)
                                    </div>
                                    <div>  <!-- Right side with buttons -->
                                        <a href="{{ url_for('main.view_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                           class="btn btn-primary btn-sm">View Assessment</a>
                                        <form action="{{ url_for('main.delete_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                              method="POST" style="display:inline;" id="deleteAssessmentForm-{{ evaluation.id }}">
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="showAssessmentDeleteConfirmation('{{ adjusted_time.strftime('%b %d, %Y %H:%M') }}', {{ evaluation.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li>No assessments run yet.</li>
                        {% endfor %}
                    </ul>
                    <div class="mt-3">  <!-- Added margin top -->
                        <a href="{{ url_for('main.start_assessment', project_id=project.id) }}" 
                           class="btn btn-primary">Start New Assessment (Claude)</a>
                    </div>
                </div>
            </div>

            <div class="card mb-3">  <!-- Notes card -->
                <div class="card-body">
                    <h5 class="card-title">Project Notes</h5>
                    <form id="notesForm" method="POST" action="{{ url_for('main.update_notes', project_id=project.id) }}">
                        <div class="form-group">
                            <textarea class="form-control" id="notes" name="notes" rows="4">{{ project.notes or '' }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Notes</button>
                    </form>
                </div>
            </div>

        </div>

        <div class="col-md-4">  <!-- Right column for project details -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Project Details</h5>
                    
                    <!-- View-only table -->
                    <table class="table table-sm" id="projectViewTable">
                        <tbody>
                            <tr>
                                <th>Funding Round</th>
                                <td>
                                    {% if project.name_of_round == 1.0 %}
                                        First Round
                                    {% elif project.name_of_round == 2.0 %}
                                        Second Round
                                    {% elif project.name_of_round == 3.0 %}
                                        Third Round
                                    {% else %}
                                        Round {{ project.name_of_round }}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>File Number</th>
                                <td>{{ project.file_number_db }}</td>
                            </tr>
                            <tr>
                                <th>Scope</th>
                                <td>{{ project.scope }}</td>
                            </tr>
                            <tr>
                                <th>Region</th>
                                <td>{{ project.region }}</td>
                            </tr>
                            <tr>
                                <th>Countries</th>
                                <td>{{ project.countries_covered }}</td>
                            </tr>
                            <tr>
                                <th>Partner Name</th>
                                <td>{{ project.integrity_partner_name }}</td>
                            </tr>
                            <tr>
                                <th>Partner Type</th>
                                <td>{{ project.partner_type }}</td>
                            </tr>
                            <tr>
                                <th>Project Partners</th>
                                <td>{{ project.project_partners }}</td>
                            </tr>
                            <tr>
                                <th>WB/EIB</th>
                                <td>{{ project.wb_or_eib }}</td>
                            </tr>
                            <tr>
                                <th>Objectives</th>
                                <td>{{ project.key_project_objectives }}</td>
                            </tr>
                            <tr>
                                <th>Sectoral Scope</th>
                                <td>{{ project.sectoral_scope }}</td>
                            </tr>
                            <tr>
                                <th>Specific Sector</th>
                                <td>{{ project.specific_sector }}</td>
                            </tr>
                            <tr>
                                <th>Funding (USD)</th>
                                <td>
                                    {% if project.funding_amount_usd %}
                                        ${{ "{:,.1f}".format(project.funding_amount_usd) }} million
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Duration</th>
                                <td>{{ project.duration }}</td>
                            </tr>
                            <tr>
                                <th>Years</th>
                                <td>{{ project.start_year }} - {{ project.end_year }}</td>
                            </tr>
                            <tr>
                                <th>WB Income Class</th>
                                <td>{{ project.wb_income_classification }}</td>
                            </tr>
                            <tr>
                                <th>Corruption Quintile</th>
                                <td>{{ project.corruption_quintile or '' }}</td>
                            </tr>
                            <tr>
                                <th>CCI</th>
                                <td>{{ "%.2f"|format(project.cci|float) if project.cci }}</td>
                            </tr>
                            <tr>
                                <th>Gov Type (EIU)</th>
                                <td>{{ project.government_type_eiu }}</td>
                            </tr>
                            <tr>
                                <th>Gov Score (EIU)</th>
                                <td>{{ "%.2f"|format(project.government_score_eiu|float) if project.government_score_eiu }}</td>
                            </tr>
                            <tr>
                                <th>Documents Available</th>
                                <td>
                                    {% if project.final_external_evaluation %}Final Evaluation<br>{% endif %}
                                    {% if project.final_report %}Final Report<br>{% endif %}
                                    {% if project.full_proposal %}Full Proposal<br>{% endif %}
                                    {% if project.workplan %}Workplan<br>{% endif %}
                                    {% if project.baseline_assessment %}Baseline Assessment{% endif %}
                                </td>
                            </tr>
                            {% if project.other %}
                            <tr>
                                <th>Other</th>
                                <td>{{ project.other }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td colspan="2" class="text-right">
                                    <button type="button" class="btn btn-primary btn-sm edit-details-btn">Edit Details</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Edit form -->
                    <form id="projectEditForm" style="display: none;" method="POST" 
                          action="{{ url_for('main.update_project', project_id=project.id) }}">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>Funding Round</th>
                                    <td>
                                        <select class="form-control form-control-sm" name="name_of_round">
                                            <option value="1.0" {% if project.name_of_round == 1.0 %}selected{% endif %}>First Round</option>
                                            <option value="2.0" {% if project.name_of_round == 2.0 %}selected{% endif %}>Second Round</option>
                                            <option value="3.0" {% if project.name_of_round == 3.0 %}selected{% endif %}>Third Round</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <th>File Number</th>
                                    <td><input type="text" class="form-control form-control-sm" name="file_number_db" value="{{ project.file_number_db }}"></td>
                                </tr>
                                <tr>
                                    <th>Scope</th>
                                    <td><input type="text" class="form-control form-control-sm" name="scope" value="{{ project.scope }}"></td>
                                </tr>
                                <tr>
                                    <th>Region</th>
                                    <td><input type="text" class="form-control form-control-sm" name="region" value="{{ project.region }}"></td>
                                </tr>
                                <tr>
                                    <th>Countries</th>
                                    <td><input type="text" class="form-control form-control-sm" name="countries_covered" value="{{ project.countries_covered }}"></td>
                                </tr>
                                <tr>
                                    <th>Partner Name</th>
                                    <td><input type="text" class="form-control form-control-sm" name="integrity_partner_name" value="{{ project.integrity_partner_name }}"></td>
                                </tr>
                                <tr>
                                    <th>Partner Type</th>
                                    <td><input type="text" class="form-control form-control-sm" name="partner_type" value="{{ project.partner_type }}"></td>
                                </tr>
                                <tr>
                                    <th>Project Partners</th>
                                    <td><input type="text" class="form-control form-control-sm" name="project_partners" value="{{ project.project_partners }}"></td>
                                </tr>
                                <tr>
                                    <th>WB/EIB</th>
                                    <td><input type="text" class="form-control form-control-sm" name="wb_or_eib" value="{{ project.wb_or_eib }}"></td>
                                </tr>
                                <tr>
                                    <th>Objectives</th>
                                    <td><textarea class="form-control form-control-sm" name="key_project_objectives" rows="3">{{ project.key_project_objectives or '' }}</textarea></td>
                                </tr>
                                <tr>
                                    <th>Sectoral Scope</th>
                                    <td><input type="text" class="form-control form-control-sm" name="sectoral_scope" value="{{ project.sectoral_scope or '' }}"></td>
                                </tr>
                                <tr>
                                    <th>Specific Sector</th>
                                    <td><input type="text" class="form-control form-control-sm" name="specific_sector" value="{{ project.specific_sector or '' }}"></td>
                                </tr>
                                <tr>
                                    <th>Funding (USD)</th>
                                    <td><input type="number" step="0.1" class="form-control form-control-sm" name="funding_amount_usd" value="{{ project.funding_amount_usd or '' }}"></td>
                                </tr>
                                <tr>
                                    <th>Years</th>
                                    <td class="d-flex">
                                        <input type="number" class="form-control form-control-sm mr-2" name="start_year" value="{{ project.start_year }}" style="width: 100px">
                                        <span class="align-self-center">-</span>
                                        <input type="number" class="form-control form-control-sm ml-2" name="end_year" value="{{ project.end_year }}" style="width: 100px">
                                    </td>
                                </tr>
                                <tr>
                                    <th>Duration</th>
                                    <td><input type="text" class="form-control form-control-sm" name="duration" value="{{ project.duration or '' }}"></td>
                                </tr>
                                <tr>
                                    <th>WB Income Class</th>
                                    <td><input type="text" class="form-control form-control-sm" name="wb_income_classification" value="{{ project.wb_income_classification }}"></td>
                                </tr>
                                <tr>
                                    <th>Corruption Quintile</th>
                                    <td><input type="text" class="form-control form-control-sm" name="corruption_quintile" value="{{ project.corruption_quintile or '' }}"></td>
                                </tr>
                                <tr>
                                    <th>CCI</th>
                                    <td><input type="number" step="0.01" class="form-control form-control-sm" name="cci" value="{{ "%.2f"|format(project.cci|float) if project.cci else '' }}"></td>
                                </tr>
                                <tr>
                                    <th>Gov Type (EIU)</th>
                                    <td><input type="text" class="form-control form-control-sm" name="government_type_eiu" value="{{ project.government_type_eiu or '' }}"></td>
                                </tr>
                                <tr>
                                    <th>Gov Score (EIU)</th>
                                    <td><input type="number" step="0.01" class="form-control form-control-sm" name="government_score_eiu" value="{{ "%.2f"|format(project.government_score_eiu|float) if project.government_score_eiu else '' }}"></td>
                                </tr>
                                {% if project.other %}
                                <tr>
                                    <th>Other</th>
                                    <td><input type="text" class="form-control form-control-sm" name="other" value="{{ project.other }}"></td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                            <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Document Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the document:</p>
                    <p class="font-weight-bold" id="documentName"></p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete Document</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Delete Confirmation Modal -->
    <div class="modal fade" id="deleteAssessmentModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Assessment Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the assessment from:</p>
                    <p class="font-weight-bold" id="assessmentDate"></p>
                    <p class="text-danger">This action cannot be undone and will delete all responses associated with this assessment.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmAssessmentDelete">Delete Assessment</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Project details scripts loaded');
        
        // Add form submit handler
        const projectEditForm = document.getElementById('projectEditForm');
        if (projectEditForm) {
            projectEditForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submit triggered');
                
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error updating project: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating project. Please try again.');
                });
            });
        }

        // Add notes form submit handler
        const notesForm = document.getElementById('notesForm');
        if (notesForm) {
            notesForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                        alert.innerHTML = `
                            Notes updated successfully
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&times;</span>
                            </button>
                        `;
                        notesForm.appendChild(alert);
                        setTimeout(() => alert.remove(), 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger alert-dismissible fade show mt-2';
                    alert.innerHTML = `
                        Error updating notes. Please try again.
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    `;
                    notesForm.appendChild(alert);
                });
            });
        }
    });

    // Toggle function for edit mode
    function testToggle() {
        console.log('Toggle called');  // Debug log
        var viewTable = document.getElementById('projectViewTable');
        var editForm = document.getElementById('projectEditForm');
        
        console.log('Current display states:', {  // Debug log
            viewTable: viewTable ? viewTable.style.display : 'element not found',
            editForm: editForm ? editForm.style.display : 'element not found'
        });
        
        if (viewTable && editForm) {
            if (editForm.style.display === 'none' || editForm.style.display === '') {
                viewTable.style.display = 'none';
                editForm.style.display = 'block';
                console.log('Switched to edit mode');  // Debug log
            } else {
                viewTable.style.display = 'table';
                editForm.style.display = 'none';
                console.log('Switched to view mode');  // Debug log
            }
        } else {
            console.error('Required elements not found:', {  // Debug log
                viewTable: !!viewTable,
                editForm: !!editForm
            });
        }
    }

    // Document deletion functions
    function showDeleteConfirmation(filename, documentId) {
        document.getElementById('documentName').textContent = filename;
        document.getElementById('confirmDelete').onclick = function() {
            document.getElementById('deleteForm-' + documentId).submit();
        };
        $('#deleteConfirmationModal').modal('show');
    }

    function showAssessmentDeleteConfirmation(date, assessmentId) {
        document.getElementById('assessmentDate').textContent = date;
        document.getElementById('confirmAssessmentDelete').onclick = function() {
            document.getElementById('deleteAssessmentForm-' + assessmentId).submit();
        };
        $('#deleteAssessmentModal').modal('show');
    }
    </script>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Document ready fired');
    
    // Bind click handler directly to button
    $('.edit-details-btn').on('click', function() {
        console.log('Edit button clicked');
        $('#projectViewTable').hide();
        $('#projectEditForm').show();
    });
    
    // Bind click handler to cancel button
    $('.cancel-edit-btn').on('click', function() {
        console.log('Cancel button clicked');
        $('#projectViewTable').show();
        $('#projectEditForm').hide();
    });
});
</script>
{% endblock %} 