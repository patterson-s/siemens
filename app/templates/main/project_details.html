{% extends "base.html" %}

{% block content %}
    <h1 class="my-4">{{ project.name }}</h1>
    
    <div class="row">
        <div class="col-md-8">  <!-- Left column for documents and assessments -->
            <div class="card mb-3">  <!-- Documents card -->
                <div class="card-body">
                    <h5 class="card-title">Documents</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Uploaded Documents</h6>
                    <ul class="list-unstyled">
                        {% for document in project.documents %}
                            <li class="mb-2">
                                {% set file_ext = document.filename.split('.')[-1]|lower %}
                                {% if file_ext == 'pdf' %}
                                    <i class="fas fa-file-pdf text-danger"></i>
                                {% elif file_ext in ['doc', 'docx'] %}
                                    <i class="fas fa-file-word text-primary"></i>
                                {% elif file_ext == 'txt' %}
                                    <i class="fas fa-file-alt text-secondary"></i>
                                {% else %}
                                    <i class="fas fa-file text-secondary"></i>
                                {% endif %}
                                <span class="ml-2">{{ document.filename }}</span>
                                <span class="text-muted">({{ document.document_type|replace('_', ' ')|title }})</span>
                                <form action="{{ url_for('main.delete_document', project_id=project.id, document_id=document.id) }}" 
                                      method="POST" style="display:inline;" id="deleteForm-{{ document.id }}">
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="showDeleteConfirmation('{{ document.filename }}', {{ document.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </li>
                        {% else %}
                            <li><i class="fas fa-info-circle text-info"></i> No documents uploaded yet.</li>
                        {% endfor %}
                    </ul>
                    <a href="{{ url_for('main.upload_document', project_id=project.id) }}" class="btn btn-primary">Upload Document</a>
                </div>
            </div>

            <div class="card mb-3">  <!-- Assessments card -->
                <div class="card-body">
                    <h5 class="card-title">Assessments</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Previous Assessment Runs</h6>
                    <ul class="list-unstyled">
                        {% for evaluation in project.evaluation_runs|sort(attribute='created_at', reverse=True) %}
                            <li class="mb-2">
                                {% set adjusted_time = evaluation.created_at.replace(
                                    hour=(evaluation.created_at.hour - 4) % 24,
                                    day=evaluation.created_at.day - 1 if evaluation.created_at.hour < 4 else evaluation.created_at.day
                                ) %}
                                {{ adjusted_time.strftime('%b %d, %Y %H:%M') }} EDT
                                using {{ evaluation.model_used|replace('claude-', 'Claude ')|replace('-latest', '')|replace('-', '.')|title }}
                                ({{ evaluation.responses|length }} questions)
                                <div class="float-right">
                                    <a href="{{ url_for('main.view_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                       class="btn btn-primary">View Assessment</a>
                                    <form action="{{ url_for('main.delete_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                          method="POST" style="display:inline;" id="deleteAssessmentForm-{{ evaluation.id }}">
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="showAssessmentDeleteConfirmation('{{ adjusted_time.strftime('%b %d, %Y %H:%M') }}', {{ evaluation.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </li>
                        {% else %}
                            <li>No assessments run yet.</li>
                        {% endfor %}
                    </ul>
                    <div class="mt-3">
                        <a href="{{ url_for('main.start_assessment', project_id=project.id) }}" 
                           class="btn btn-primary">Start New Assessment (Claude)</a>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-md-4">  <!-- Right column for project details -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Project Details</h5>
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th>Round</th>
                                <td>{{ project.name_of_round }}</td>
                            </tr>
                            <tr>
                                <th>File Number</th>
                                <td>{{ project.file_number_db }}</td>
                            </tr>
                            <tr>
                                <th>Scope</th>
                                <td>{{ project.scope }}</td>
                            </tr>
                            <tr>
                                <th>Region</th>
                                <td>{{ project.region }}</td>
                            </tr>
                            <tr>
                                <th>Countries</th>
                                <td>{{ project.countries_covered }}</td>
                            </tr>
                            <tr>
                                <th>Partner Name</th>
                                <td>{{ project.integrity_partner_name }}</td>
                            </tr>
                            <tr>
                                <th>Partner Type</th>
                                <td>{{ project.partner_type }}</td>
                            </tr>
                            <tr>
                                <th>Project Partners</th>
                                <td>{{ project.project_partners }}</td>
                            </tr>
                            <tr>
                                <th>WB/EIB</th>
                                <td>{{ project.wb_or_eib }}</td>
                            </tr>
                            <tr>
                                <th>Objectives</th>
                                <td>{{ project.key_project_objectives }}</td>
                            </tr>
                            <tr>
                                <th>Sectoral Scope</th>
                                <td>{{ project.sectoral_scope }}</td>
                            </tr>
                            <tr>
                                <th>Specific Sector</th>
                                <td>{{ project.specific_sector }}</td>
                            </tr>
                            <tr>
                                <th>Funding (USD)</th>
                                <td>{{ project.funding_amount_usd }}</td>
                            </tr>
                            <tr>
                                <th>Duration</th>
                                <td>{{ project.duration }}</td>
                            </tr>
                            <tr>
                                <th>Years</th>
                                <td>{{ project.start_year }} - {{ project.end_year }}</td>
                            </tr>
                            <tr>
                                <th>Documents Available</th>
                                <td>
                                    {% if project.final_external_evaluation %}Final Evaluation<br>{% endif %}
                                    {% if project.final_report %}Final Report<br>{% endif %}
                                    {% if project.full_proposal %}Full Proposal<br>{% endif %}
                                    {% if project.workplan %}Workplan<br>{% endif %}
                                    {% if project.baseline_assessment %}Baseline Assessment{% endif %}
                                </td>
                            </tr>
                            {% if project.other %}
                            <tr>
                                <th>Other</th>
                                <td>{{ project.other }}</td>
                            </tr>
                            {% endif %}
                            {% if project.notes %}
                            <tr>
                                <th>Notes</th>
                                <td>{{ project.notes }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Document Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the document:</p>
                    <p class="font-weight-bold" id="documentName"></p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete Document</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Delete Confirmation Modal -->
    <div class="modal fade" id="deleteAssessmentModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Assessment Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the assessment from:</p>
                    <p class="font-weight-bold" id="assessmentDate"></p>
                    <p class="text-danger">This action cannot be undone and will delete all responses associated with this assessment.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmAssessmentDelete">Delete Assessment</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    function showDeleteConfirmation(filename, documentId) {
        // Set the document name in the modal
        document.getElementById('documentName').textContent = filename;
        
        // Set up the confirm button handler
        document.getElementById('confirmDelete').onclick = function() {
            document.getElementById('deleteForm-' + documentId).submit();
        };
        
        // Show the modal
        $('#deleteConfirmationModal').modal('show');
    }

    function showAssessmentDeleteConfirmation(date, assessmentId) {
        // Set the assessment date in the modal
        document.getElementById('assessmentDate').textContent = date;
        
        // Set up the confirm button handler
        document.getElementById('confirmAssessmentDelete').onclick = function() {
            document.getElementById('deleteAssessmentForm-' + assessmentId).submit();
        };
        
        // Show the modal
        $('#deleteAssessmentModal').modal('show');
    }
    </script>
{% endblock %} 