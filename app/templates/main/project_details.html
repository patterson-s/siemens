{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="my-4">{{ project.name }}</h1>
    
    <div class="row">
        <div class="col-md-8">
            <!-- Documents card first -->
            <div class="card mb-3">  <!-- Documents card -->
                <div class="card-body">
                    <h5 class="card-title">Documents</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Uploaded Documents</h6>
                    
                    <!-- Group documents by type -->
                    {% set document_types = {} %}
                    {% for document in project.documents %}
                        {% if document.document_type not in document_types %}
                            {% set _ = document_types.update({document.document_type: []}) %}
                        {% endif %}
                        {% set _ = document_types[document.document_type].append(document) %}
                    {% endfor %}

                    <!-- Display each document type section -->
                    {% for doc_type, docs in document_types.items() %}
                        <h6 class="mt-3">{{ doc_type|replace('_', ' ')|title }}</h6>
                        <ul class="list-unstyled" id="{{ doc_type }}-list">
                            {% for document in docs %}
                                <li class="mb-3">
                                    <div class="document-main-line">
                                        {% set file_ext = document.filename.split('.')[-1]|lower %}
                                        {% if file_ext == 'pdf' %}
                                            <i class="fas fa-file-pdf text-danger"></i>
                                        {% elif file_ext in ['doc', 'docx'] %}
                                            <i class="fas fa-file-word text-primary"></i>
                                        {% else %}
                                            <i class="fas fa-file text-secondary"></i>
                                        {% endif %}
                                        <span class="ml-2">{{ document.filename }}</span>
                                        
                                        <span class="float-right">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-primary preview-btn" 
                                                    data-document-id="{{ document.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <form action="{{ url_for('main.delete_document', project_id=project.id, document_id=document.id) }}" 
                                                  method="POST" style="display:inline;" id="deleteForm-{{ document.id }}">
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="showDeleteConfirmation('{{ document.filename }}', {{ document.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </span>
                                    </div>
                                    <div class="document-details text-muted ml-4">
                                        <small>
                                            {{ document.document_type|replace('_', ' ')|title }} - 
                                            {{ "{:,}".format(document.file_size) }} words
                                        </small>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endfor %}

                    <a href="{{ url_for('main.upload_document', project_id=project.id) }}" class="btn btn-primary">Upload Document</a>
                </div>
            </div>

            <!-- Question Responses card second -->
            <div class="card mb-3">
                <div class="card-header custom-teal d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AI Responses</h5>
                    <div>
                        <button class="btn btn-sm btn-header-action mr-2" onclick="toggleAllResponses(true)">
                            <i class="fas fa-expand-alt"></i> Expand All
                        </button>
                        <button class="btn btn-sm btn-header-action" onclick="toggleAllResponses(false)">
                            <i class="fas fa-compress-alt"></i> Collapse All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Question Responses section -->
                    {% if latest_responses %}
                        {% for response in latest_responses|sort(attribute='question.order') %}
                            <div class="mb-3">
                                <!-- Question header -->
                                <div class="btn btn-outline-teal text-left w-100 d-flex justify-content-between align-items-center" 
                                     data-toggle="collapse" 
                                     data-target="#response{{ response.id }}"
                                     aria-expanded="false"
                                     aria-controls="response{{ response.id }}"
                                     style="cursor: pointer;">
                                    <!-- Question title -->
                                    <span class="text-truncate" style="max-width: 70%;">{{ response.question.name }}</span>
                                    
                                    <!-- Review status and expand icon -->
                                    <span>
                                        {% if response.reviewed %}
                                            <span class="badge badge-success mr-2" style="min-width: 100px;">Reviewed</span>
                                        {% else %}
                                            <span class="badge badge-outline-info mr-2" style="min-width: 100px;">Not Reviewed</span>
                                        {% endif %}
                                        <i class="fas fa-chevron-down"></i>
                                    </span>
                                </div>

                                <!-- Response content -->
                                <div class="collapse" id="response{{ response.id }}">
                                    <div class="card card-body mt-2 border-left border-teal">
                                        <!-- Response text container -->
                                        <div id="responseText{{ response.id }}" class="response-text">
                                            {{ response.response_text|nl2br|safe }}
                                        </div>
                                        
                                        <!-- Edit form (hidden by default) -->
                                        <div id="responseEditForm{{ response.id }}" class="response-edit-form" style="display: none;">
                                            <div class="form-group">
                                                <textarea class="form-control mb-2" 
                                                          id="responseText{{ response.id }}" 
                                                          name="responseText" 
                                                          rows="15" 
                                                          style="resize: both;"
                                                          required>{{ response.response_text }}</textarea>
                                            </div>
                                            <div class="text-right">
                                                <button class="btn btn-sm btn-secondary mr-2" onclick="cancelEdit({{ response.id }})">Cancel</button>
                                                <button class="btn btn-sm btn-success" onclick="saveEdit({{ response.id }})">Save Changes</button>
                                            </div>
                                        </div>

                                        <div class="text-right mt-3">
                                            <button class="btn btn-sm btn-outline-secondary mr-2" 
                                                    onclick="startEdit({{ response.id }})"
                                                    id="editBtn{{ response.id }}">
                                                <i class="fas fa-edit mr-1"></i>Edit Response
                                            </button>
                                            
                                            {% if response.reviewed %}
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="unmarkAsReviewed(event, {{ response.id }})"
                                                        id="unreviewBtn{{ response.id }}">
                                                    <i class="fas fa-times mr-1"></i>Unmark as Reviewed
                                                </button>
                                            {% else %}
                                                <button class="btn btn-sm btn-primary" 
                                                        onclick="markAsReviewed(event, {{ response.id }})"
                                                        id="reviewBtn{{ response.id }}">
                                                    <i class="fas fa-check mr-1"></i>Mark as Reviewed
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No responses generated.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Assessments card last -->
            <div class="card">
                <div class="card-body">
                    <!--
                    <h5 class="card-title">Generate AI Responses</h5>
                    
                    <h6 class="card-subtitle mb-2 text-muted">Saved Response Runs</h6>
                    <ul class="list-unstyled">
                        {% for evaluation in project.evaluation_runs|sort(attribute='created_at', reverse=True) %}
                            <li class="mb-3">  
                                <div class="d-flex justify-content-between align-items-center"> 
                                    <div>  
                                        {% set adjusted_time = evaluation.created_at.replace(
                                            hour=(evaluation.created_at.hour - 4) % 24,
                                            day=evaluation.created_at.day - 1 if evaluation.created_at.hour < 4 else evaluation.created_at.day
                                        ) %}
                                        {{ adjusted_time.strftime('%b %d, %Y %H:%M') }} EDT
                                        using {{ evaluation.model_used|replace('claude-', 'Claude ')|replace('-latest', '')|replace('-', '.')|title }}
                                        ({{ evaluation.responses|length }} questions)
                                    </div>
                                    <div>  
                                        <a href="{{ url_for('main.view_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <form action="{{ url_for('main.delete_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                              method="POST" style="display:inline;" id="deleteAssessmentForm-{{ evaluation.id }}">
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="showAssessmentDeleteConfirmation('{{ adjusted_time.strftime('%b %d, %Y %H:%M') }}', {{ evaluation.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li>No responses generated yet.</li>
                        {% endfor %}
                    </ul>
                    -->
                    <div class="mt-3">  <!-- Added margin top -->
                        <a href="{{ url_for('main.start_assessment', project_id=project.id) }}" 
                           class="btn btn-primary">Generate AI Responses </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Toggle buttons -->
            <div class="btn-group mb-3 w-100" role="group">
                <button type="button" class="btn btn-outline-teal" id="showDetails" 
                        style="color: #1abc9c !important; border: 1px solid #1abc9c !important; background-color: white !important;">
                    Project Details
                </button>
                <button type="button" class="btn custom-teal" id="showMetrics" 
                        style="background-color: #1abc9c !important; border-color: #1abc9c !important; color: white !important;">
                    Project Scoring
                </button>
            </div>

            <!-- Project Details Table -->
            <div class="card mb-3" id="detailsCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">Project Details</h5>
                    
                    <!-- View-only table -->
                    <div id="projectViewTable">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>Funding Round</th>
                                    <td>
                                        {% if project.name_of_round == 1.0 %}
                                            First Round
                                        {% elif project.name_of_round == 2.0 %}
                                            Second Round
                                        {% elif project.name_of_round == 3.0 %}
                                            Third Round
                                        {% else %}
                                            Round {{ project.name_of_round }}
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>File Number</th>
                                    <td>{{ project.file_number_db }}</td>
                                </tr>
                                <tr>
                                    <th>Scope</th>
                                    <td>{{ project.scope }}</td>
                                </tr>
                                <tr>
                                    <th>Region</th>
                                    <td>{{ project.region }}</td>
                                </tr>
                                <tr>
                                    <th>Countries</th>
                                    <td>{{ project.countries_covered }}</td>
                                </tr>
                                <tr>
                                    <th>Partner Name</th>
                                    <td>{{ project.integrity_partner_name }}</td>
                                </tr>
                                <tr>
                                    <th>Partner Type</th>
                                    <td>{{ project.partner_type }}</td>
                                </tr>
                                <tr>
                                    <th>Project Partners</th>
                                    <td>{{ project.project_partners }}</td>
                                </tr>
                                <tr>
                                    <th>WB/EIB</th>
                                    <td>{{ project.wb_or_eib }}</td>
                                </tr>
                                <tr>
                                    <th>Objectives</th>
                                    <td>{{ project.key_project_objectives }}</td>
                                </tr>
                                <tr>
                                    <th>Sectoral Scope</th>
                                    <td>{{ project.sectoral_scope }}</td>
                                </tr>
                                <tr>
                                    <th>Specific Sector</th>
                                    <td>{{ project.specific_sector }}</td>
                                </tr>
                                <tr>
                                    <th>Funding (USD)</th>
                                    <td>
                                        {% if project.funding_amount_usd %}
                                            ${{ "{:,.1f}".format(project.funding_amount_usd) }} million
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Duration</th>
                                    <td>{{ project.duration }}</td>
                                </tr>
                                <tr>
                                    <th>Years</th>
                                    <td>{{ project.start_year }} - {{ project.end_year }}</td>
                                </tr>
                                <tr>
                                    <th>WB Income Class</th>
                                    <td>{{ project.wb_income_classification }}</td>
                                </tr>
                                <tr>
                                    <th>Corruption Quintile</th>
                                    <td>{{ project.corruption_quintile or '' }}</td>
                                </tr>
                                <tr>
                                    <th>CCI</th>
                                    <td>{{ "%.2f"|format(project.cci|float) if project.cci is not none else "" }}</td>
                                </tr>
                                <tr>
                                    <th>Gov Type (EIU)</th>
                                    <td>{{ project.government_type_eiu }}</td>
                                </tr>
                                <tr>
                                    <th>Gov Score (EIU)</th>
                                    <td>{{ "%.2f"|format(project.government_score_eiu|float) if project.government_score_eiu }}</td>
                                </tr>
                                <tr>
                                    <th>Documents Available</th>
                                    <td>
                                        {% if project.final_external_evaluation %}Final Evaluation<br>{% endif %}
                                        {% if project.final_report %}Final Report<br>{% endif %}
                                        {% if project.full_proposal %}Full Proposal<br>{% endif %}
                                        {% if project.workplan %}Workplan<br>{% endif %}
                                        {% if project.baseline_assessment %}Baseline Assessment{% endif %}
                                    </td>
                                </tr>
                                {% if project.other %}
                                <tr>
                                    <th>Other</th>
                                    <td>{{ project.other }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                        <!-- Edit button moved here -->
                        <div class="text-right">
                            <button type="button" class="btn btn-sm btn-outline-teal edit-details-btn">
                                <i class="fas fa-edit"></i> Edit Details
                            </button>
                        </div>
                    </div>

                    <!-- Edit form -->
                    <div id="projectEditForm" style="display: none;">
                        <form method="POST" action="{{ url_for('main.update_project', project_id=project.id) }}">
                            <div class="form-group">
                                <label for="name">Name</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ project.name }}">
                            </div>
                            <div class="form-group">
                                <label for="name_of_round">Funding Round</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="name_of_round" 
                                       name="name_of_round" 
                                       step="1" 
                                       min="1"
                                       value="{{ project.name_of_round|int if project.name_of_round else '' }}">
                            </div>
                            <div class="form-group">
                                <label for="file_number_db">File Number</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="file_number_db" 
                                       name="file_number_db" 
                                       step="0.1" 
                                       min="0"
                                       pattern="\d*\.?\d{0,1}"
                                       value="{{ '%.1f'|format(project.file_number_db) if project.file_number_db else '' }}">
                            </div>
                            <div class="form-group">
                                <label for="scope">Scope</label>
                                <textarea class="form-control" id="scope" name="scope" rows="3">{{ project.scope }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="region">Region</label>
                                <input type="text" class="form-control" id="region" name="region" value="{{ project.region }}">
                            </div>
                            <div class="form-group">
                                <label for="countries_covered">Countries</label>
                                <textarea class="form-control" id="countries_covered" name="countries_covered" rows="3">{{ project.countries_covered }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="integrity_partner_name">Partner Name</label>
                                <input type="text" class="form-control" id="integrity_partner_name" name="integrity_partner_name" value="{{ project.integrity_partner_name }}">
                            </div>
                            <div class="form-group">
                                <label for="partner_type">Partner Type</label>
                                <input type="text" class="form-control" id="partner_type" name="partner_type" value="{{ project.partner_type }}">
                            </div>
                            <div class="form-group">
                                <label for="project_partners">Project Partners</label>
                                <textarea class="form-control" id="project_partners" name="project_partners" rows="3">{{ project.project_partners }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="wb_or_eib">WB/EIB</label>
                                <input type="text" class="form-control" id="wb_or_eib" name="wb_or_eib" value="{{ project.wb_or_eib }}">
                            </div>
                            <div class="form-group">
                                <label for="key_project_objectives">Objectives</label>
                                <textarea class="form-control" id="key_project_objectives" name="key_project_objectives" rows="3">{{ project.key_project_objectives }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="sectoral_scope">Sectoral Scope</label>
                                <textarea class="form-control" id="sectoral_scope" name="sectoral_scope" rows="3">{{ project.sectoral_scope }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="specific_sector">Specific Sector</label>
                                <input type="text" class="form-control" id="specific_sector" name="specific_sector" value="{{ project.specific_sector }}">
                            </div>
                            <div class="form-group">
                                <label for="funding_amount_usd">Funding (USD)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="funding_amount_usd" 
                                       name="funding_amount_usd" 
                                       min="0"
                                       step="any"
                                       pattern="\d*\.?\d{0,2}"
                                       value="{{ '%.2f'|format(project.funding_amount_usd) if project.funding_amount_usd else '' }}">
                            </div>
                            <div class="form-group">
                                <label for="start_year">Start Year</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="start_year" 
                                       name="start_year" 
                                       step="1"
                                       min="1900"
                                       max="2100"
                                       value="{{ project.start_year|int if project.start_year else '' }}">
                            </div>
                            <div class="form-group">
                                <label for="end_year">End Year</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="end_year" 
                                       name="end_year" 
                                       step="1"
                                       min="1900"
                                       max="2100"
                                       value="{{ project.end_year|int if project.end_year else '' }}">
                            </div>
                            <div class="form-group">
                                <label for="wb_income_classification">WB Income Class</label>
                                <input type="text" class="form-control" id="wb_income_classification" name="wb_income_classification" value="{{ project.wb_income_classification }}">
                            </div>
                            <div class="form-group">
                                <label for="corruption_quintile">Corruption Quintile</label>
                                <select class="form-control" id="corruption_quintile" name="corruption_quintile">
                                    <option value="" {% if not project.corruption_quintile %}selected{% endif %}>Select...</option>
                                    <option value="20%" {% if project.corruption_quintile == '20%' %}selected{% endif %}>20% (Most corrupt)</option>
                                    <option value="40%" {% if project.corruption_quintile == '40%' %}selected{% endif %}>40%</option>
                                    <option value="60%" {% if project.corruption_quintile == '60%' %}selected{% endif %}>60%</option>
                                    <option value="80%" {% if project.corruption_quintile == '80%' %}selected{% endif %}>80%</option>
                                    <option value="100%" {% if project.corruption_quintile == '100%' %}selected{% endif %}>100% (Least corrupt)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cci">CCI (Control of Corruption Index)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="cci" 
                                       name="cci" 
                                       min="-2.5"
                                       max="2.5"
                                       step="0.01"
                                       value="{{ '%.2f'|format(project.cci) if project.cci is not none else '' }}">
                                <small class="form-text text-muted">Value between -2.5 and 2.5</small>
                            </div>
                            <div class="form-group">
                                <label for="government_type_eiu">Gov Type (EIU)</label>
                                <input type="text" class="form-control" id="government_type_eiu" name="government_type_eiu" value="{{ project.government_type_eiu }}">
                            </div>
                            <div class="form-group">
                                <label for="government_score_eiu">Gov Score (EIU)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="government_score_eiu" 
                                       name="government_score_eiu" 
                                       min="0"
                                       step="any"
                                       pattern="\d*\.?\d{0,2}"
                                       value="{{ '%.2f'|format(project.government_score_eiu) if project.government_score_eiu else '' }}">
                            </div>
                            <div class="form-group">
                                <label for="notes">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3">{{ project.notes }}</textarea>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-secondary cancel-edit-btn">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Project Metrics Form -->
            <div class="card mb-3" id="metricsCard" style="background-color: rgba(23, 162, 184, 0.03);">
                <div class="card-body">
                    <h5 class="card-title">Project Scoring</h5>
                    <form id="metricsForm" action="{{ url_for('main.update_project_metrics', project_id=project.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        
                        <!-- Numeric Counts Section -->
                        <h5 class="mt-3 mb-2">2.1a Outputs by Category</h5>
                        <h6 class="mt-3 mb-2">Collective Action Outputs</h6>
                        <div class="form-group row mb-2">
                            <label for="num_pubpri_dialogues" class="col-8 col-form-label metrics-label">i. Number of public-private dialogue platforms, hubs, or centres for dialogue</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_pubpri_dialogues" 
                                       name="num_pubpri_dialogues" 
                                       step="1"
                                       min="0"
                                       value="{{ project.num_pubpri_dialogues|int if project.num_pubpri_dialogues is not none else 0 }}">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="num_legal_contribuntions" class="col-8 col-form-label metrics-label">ii. Number of domestic laws/policies introduced or influenced</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_legal_contribuntions" 
                                       name="num_legal_contribuntions"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_legal_contribuntions|int if project.num_legal_contribuntions is not none else 0 }}">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="num_implement_mechanisms" class="col-8 col-form-label metrics-label">iii. Number of procurement rules, procedures or systems influenced</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_implement_mechanisms" 
                                       name="num_implement_mechanisms"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_implement_mechanisms|int if project.num_implement_mechanisms is not none else 0 }}">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="num_voluntary_standards" class="col-8 col-form-label metrics-label">iv. Number of voluntary standards/integrity pacts/ codes of conduct created or strengthened</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_voluntary_standards" 
                                       name="num_voluntary_standards"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_voluntary_standards|int if project.num_voluntary_standards is not none else 0 }}">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="num_voluntary_signatories" class="col-8 col-form-label metrics-label">v. Number of actors signing up to pacts/voluntary standards, or codes of conducts</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_voluntary_signatories" 
                                       name="num_voluntary_signatories"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_voluntary_signatories|int if project.num_voluntary_signatories is not none else 0 }}">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="num_organizations_supported" class="col-8 col-form-label metrics-label">vi. Number of organizations supported in/encouraged to engage in anti-corruption</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_organizations_supported" 
                                       name="num_organizations_supported"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_organizations_supported|int if project.num_organizations_supported is not none else 0 }}">
                            </div>
                        </div>

                        <!-- After the existing num_organizations_supported field -->
                        <h6 class="mt-3 mb-2">Education and Training Outputs</h6>
                        <div class="form-group row mb-2">
                            <label for="num_new_courses" class="col-8 col-form-label metrics-label">Number of new courses/curricula/training materials developed</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_new_courses" 
                                       name="num_new_courses"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_new_courses|int if project.num_new_courses is not none else 0 }}">
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label for="num_individ_trained" class="col-8 col-form-label metrics-label">Total number of individuals educated/trained</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_individ_trained" 
                                       name="num_individ_trained"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_individ_trained|int if project.num_individ_trained is not none else 0 }}">
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label for="num_training_activities" class="col-8 col-form-label metrics-label">Total number of training/capacity building activities</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_training_activities" 
                                       name="num_training_activities"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_training_activities|int if project.num_training_activities is not none else 0 }}">
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label for="num_organizaed_events" class="col-8 col-form-label metrics-label">Number of major events (conferences, fairs) organized or co-organized</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_organizaed_events" 
                                       name="num_organizaed_events"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_organizaed_events|int if project.num_organizaed_events is not none else 0 }}">
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label for="num_event_attendees" class="col-8 col-form-label metrics-label">Number of people attending said events</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_event_attendees" 
                                       name="num_event_attendees"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_event_attendees|int if project.num_event_attendees is not none else 0 }}">
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label for="num_publications" class="col-8 col-form-label metrics-label">Number of publications produced by the project</label>
                            <div class="col-4">
                                <input type="number" 
                                       class="form-control" 
                                       id="num_publications" 
                                       name="num_publications"
                                       step="1"
                                       min="0"
                                       value="{{ project.num_publications|int if project.num_publications is not none else 0 }}">
                            </div>
                        </div>

                        <!-- New section: 2.1b Outputs Rating -->
                        <h5 class="mt-4 mb-2">2.1b Outputs Rating</h5>
                        <div class="form-group row mb-2">
                            <label for="rate_output_achieved" class="col-8 col-form-label metrics-label">To what extent have the agreed upon outputs been achieved?</label>
                            <div class="col-4">
                                <select class="form-control" id="rate_output_achieved" name="rate_output_achieved">
                                    <option value="" {% if not project.rate_output_achieved %}selected{% endif %}>Select...</option>
                                    <option value="4" {% if project.rate_output_achieved == 4 %}selected{% endif %}>4 - Delivered all agreed</option>
                                    <option value="3" {% if project.rate_output_achieved == 3 %}selected{% endif %}>3 - Delivered most agreed</option>
                                    <option value="2" {% if project.rate_output_achieved == 2 %}selected{% endif %}>2 - Delivered some agreed</option>
                                    <option value="1" {% if project.rate_output_achieved == 1 %}selected{% endif %}>1 - Delivered none or few agreed</option>
                                </select>
                            </div>
                        </div>

                        <h5 class="mt-4 mb-2">2.3 Impact Evidence</h5>
                        <div class="form-group row mb-2">
                            <label for="rate_impact_evidence" class="col-8 col-form-label metrics-label">Is there evidence that overall project made a contribution to impact?</label>
                            <div class="col-4">
                                <select class="form-control" id="rate_impact_evidence" name="rate_impact_evidence">
                                    <option value="" {% if not project.rate_impact_evidence %}selected{% endif %}>Select...</option>
                                    <option value="Yes" {% if project.rate_impact_evidence == 'Yes' %}selected{% endif %}>Yes</option>
                                    <option value="No" {% if project.rate_impact_evidence == 'No' %}selected{% endif %}>No</option>
                                    <option value="Unclear" {% if project.rate_impact_evidence == 'Unclear' %}selected{% endif %}>Unclear</option>
                                </select>
                            </div>
                        </div>

                        <h5 class="mt-4 mb-2">2.5 Sustainability</h5>
                        <div class="form-group row mb-2">
                            <label for="rate_sustainability" class="col-8 col-form-label metrics-label">To what extent are project results likely to be sustained beyond project end?</label>
                            <div class="col-4">
                                <select class="form-control" id="rate_sustainability" name="rate_sustainability">
                                    <option value="" {% if not project.rate_sustainability %}selected{% endif %}>Select...</option>
                                    <option value="4" {% if project.rate_sustainability == 4 %}selected{% endif %}>4</option>                                 
                                    <option value="3.5" {% if project.rate_sustainability == 3.5 %}selected{% endif %}>3.5</option>
                                    <option value="3" {% if project.rate_sustainability == 3 %}selected{% endif %}>3</option>
                                    <option value="2.5" {% if project.rate_sustainability == 2.5 %}selected{% endif %}>2.5</option>
                                    <option value="2" {% if project.rate_sustainability == 2 %}selected{% endif %}>2</option>
                                    <option value="1.5" {% if project.rate_sustainability == 1.5 %}selected{% endif %}>1.5</option>
                                    <option value="1" {% if project.rate_sustainability == 1 %}selected{% endif %}>1</option>
                                </select>
                            </div>
                        </div>

                        <h5 class="mt-4 mb-2">2.6 Internal Factors</h5>
                        <div class="form-group mb-3">
                            <label for="rate_project_design" class="d-block mb-2 metrics-label">Project Design Rating:</label>
                            <select class="form-control" id="rate_project_design" name="rate_project_design">
                                <option value="" {% if project.rate_project_design is none %}selected{% endif %}>Select...</option>
                                <option value="4" {% if project.rate_project_design == 4 %}selected{% endif %}>4</option>
                                <option value="3.5" {% if project.rate_project_design == 3.5 %}selected{% endif %}>3.5</option>
                                <option value="3" {% if project.rate_project_design == 3 %}selected{% endif %}>3</option>
                                <option value="2.5" {% if project.rate_project_design == 2.5 %}selected{% endif %}>2.5</option>
                                <option value="2" {% if project.rate_project_design == 2 %}selected{% endif %}>2</option>
                                <option value="1.5" {% if project.rate_project_design == 1.5 %}selected{% endif %}>1.5</option>
                                <option value="1" {% if project.rate_project_design == 1 %}selected{% endif %}>1</option>
                                <option value="0" {% if project.rate_project_design == 0 %}selected{% endif %}>0</option>
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="rate_project_management" class="d-block mb-2 metrics-label">Project Management Rating:</label>
                            <select class="form-control" id="rate_project_management" name="rate_project_management">
                                <option value="" {% if not project.rate_project_management %}selected{% endif %}>Select...</option>
                                <option value="considerable concerns" {% if project.rate_project_management == 'considerable concerns' %}selected{% endif %}>Considerable Concerns</option>
                                <option value="minor concerns" {% if project.rate_project_management == 'minor concerns' %}selected{% endif %}>Minor Concerns</option>
                                <option value="no concerns" {% if project.rate_project_management == 'no concerns' %}selected{% endif %}>No Concerns</option>
                            </select>
                        </div>

                        <h5 class="mt-4 mb-2">Contributions Summary</h5>
                        <div class="form-group mb-3">
                            <label for="rate_signif_frameworks" class="d-block mb-2 metrics-label">Rate contributions to Strengthened Governance and Legal Frameworks :</label>
                            <select class="form-control" id="rate_signif_frameworks" name="rate_signif_frameworks">
                                <option value="" {% if not project.rate_signif_frameworks %}selected{% endif %}>Select...</option>
                                <option value="significant" {% if project.rate_signif_frameworks == 'significant' %}selected{% endif %}>Significant</option>
                                <option value="moderate" {% if project.rate_signif_frameworks == 'moderate' %}selected{% endif %}>Moderate</option>
                                <option value="modest" {% if project.rate_signif_frameworks == 'modest' %}selected{% endif %}>Modest</option>
                                <option value="no contribution" {% if project.rate_signif_frameworks == 'no contribution' %}selected{% endif %}>No Contribution</option>
                                <option value="not operating in this realm" {% if project.rate_signif_frameworks == 'not operating in this realm' %}selected{% endif %}>Not Operating in This Realm</option>
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="rate_signif_practices" class="d-block mb-2 metrics-label">Rate contributions to Improved Organizational Practices :</label>
                            <select class="form-control" id="rate_signif_practices" name="rate_signif_practices">
                                <option value="" {% if not project.rate_signif_practices %}selected{% endif %}>Select...</option>
                                <option value="significant" {% if project.rate_signif_practices == 'significant' %}selected{% endif %}>Significant</option>
                                <option value="moderate" {% if project.rate_signif_practices == 'moderate' %}selected{% endif %}>Moderate</option>
                                <option value="modest" {% if project.rate_signif_practices == 'modest' %}selected{% endif %}>Modest</option>
                                <option value="no contribution" {% if project.rate_signif_practices == 'no contribution' %}selected{% endif %}>No Contribution</option>
                                <option value="not operating in this realm" {% if project.rate_signif_practices == 'not operating in this realm' %}selected{% endif %}>Not Operating in This Realm</option>
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="rate_signif_capacity" class="d-block mb-2 metrics-label">Rate contributions to Enhanced Anti-corruption Capacity :</label>
                            <select class="form-control" id="rate_signif_capacity" name="rate_signif_capacity">
                                <option value="" {% if not project.rate_signif_capacity %}selected{% endif %}>Select...</option>
                                <option value="significant" {% if project.rate_signif_capacity == 'significant' %}selected{% endif %}>Significant</option>
                                <option value="moderate" {% if project.rate_signif_capacity == 'moderate' %}selected{% endif %}>Moderate</option>
                                <option value="modest" {% if project.rate_signif_capacity == 'modest' %}selected{% endif %}>Modest</option>
                                <option value="no contribution" {% if project.rate_signif_capacity == 'no contribution' %}selected{% endif %}>No Contribution</option>
                                <option value="not operating in this realm" {% if project.rate_signif_capacity == 'not operating in this realm' %}selected{% endif %}>Not Operating in This Realm</option>
                            </select>
                        </div>


                        <h5 class="mt-4 mb-2">Evaluation Quality</h5>
                        <div class="form-group mb-3">
                            <label for="rate_quality_evaluation" class="d-block mb-2 metrics-label">Rate the overall quality of the external evaluation:</label>
                            <select class="form-control" id="rate_quality_evaluation" name="rate_quality_evaluation">
                                <option value="" {% if not project.rate_quality_evaluation %}selected{% endif %}>Select...</option>
                                <option value="High" {% if project.rate_quality_evaluation == 'High' %}selected{% endif %}>High Value (23-28)</option>
                                <option value="Medium-High" {% if project.rate_quality_evaluation == 'Medium-High' %}selected{% endif %}>Medium-High Value (17-22)</option>
                                <option value="Medium-Low" {% if project.rate_quality_evaluation == 'Medium-Low' %}selected{% endif %}>Medium-Low Value (11-16)</option>
                                <option value="Low" {% if project.rate_quality_evaluation == 'Low' %}selected{% endif %}>Low Value (10 or below)</option>
                            </select>
                        </div>


                        <button type="submit" class="btn btn-primary mt-3">Save Ratings</button>
                    </form>
                </div>
            </div>

            <!-- Notes card moved here -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Project Notes</h5>
                    <form id="notesForm" method="POST" action="{{ url_for('main.update_notes', project_id=project.id) }}">
                        <div class="form-group">
                            <textarea class="form-control" id="notes" name="notes" rows="4">{{ project.notes or '' }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Notes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Document Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the document:</p>
                <p class="font-weight-bold" id="documentName"></p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Document</button>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Delete Confirmation Modal -->
<div class="modal fade" id="deleteAssessmentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Assessment Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the assessment from:</p>
                <p class="font-weight-bold" id="assessmentDate"></p>
                <p class="text-danger">This action cannot be undone and will delete all responses associated with this assessment.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmAssessmentDelete">Delete Assessment</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this near the bottom of the template, before the scripts -->
<div class="modal fade" id="documentPreviewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Document Preview</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Update search box -->
                <div class="search-box mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="documentSearchInput" 
                               placeholder="Search in document...">
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="caseSensitive">
                                    <label class="custom-control-label" for="caseSensitive">Aa</label>
                                </div>
                            </div>
                            <button class="btn btn-outline-secondary" id="prevMatch" disabled>
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="btn btn-outline-secondary" id="nextMatch" disabled>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <span class="input-group-text text-muted" id="searchCount">0 matches</span>
                        </div>
                    </div>
                </div>
                <div class="document-content" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    .custom-teal {
        background-color: #1abc9c !important;
        border-color: #1abc9c !important;
        color: white !important;
    }
    .btn-outline-teal {
        color: #1abc9c !important;
        border: 1px solid #1abc9c !important;
        background-color: white !important;
        padding: 0.25rem 0.5rem !important;
        font-size: 0.875rem !important;
    }
    .btn-outline-teal:hover {
        color: white !important;
        background-color: #1abc9c !important;
    }
    .border-teal {
        border-color: #1abc9c !important;
    }
    .btn-header-action {
        color: white !important;
        border: 1px solid white !important;
        background: transparent !important;
    }
    .btn-header-action:hover {
        background: rgba(255, 255, 255, 0.2) !important;
    }
    .btn-teal {
        background-color: #1abc9c !important;
        border: 1px solid #1abc9c !important;
        color: white !important;
        padding: 0.25rem 0.5rem !important;
        font-size: 0.875rem !important;
    }
    .btn-outline-teal.review-toggle {
        display: none;
    }
    .badge {
        padding: 0.4rem 0.6rem !important;
        font-weight: 400 !important;
        font-size: 0.875rem !important;
        text-transform: none !important;
    }
    
    .badge.badge-outline-info,
    .badge-outline-info {
        color: #1abc9c !important;
        background-color: white !important;
        border: 1px solid #1abc9c !important;
        font-weight: 400 !important;
    }
    
    .badge.badge-success,
    .badge-success {
        background-color: #28a745 !important;
        color: white !important;
        font-weight: 400 !important;
    }
    .metrics-label {
        font-size: 0.75rem;  /* 14px if base is 16px */
        line-height: 1.2;
    }
    .document-text {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 0.9rem;
        line-height: 1.5;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .preview-btn {
        padding: 0.25rem 0.5rem;
        margin-right: 5px;
        border: 1px solid #007bff;  /* Bootstrap primary color */
    }
    .preview-btn:hover {
        background-color: #007bff;
        color: white;
    }
    .btn-link.preview-btn {
        text-decoration: none !important;
        color: #007bff;
    }
    .document-main-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .document-main-line > span:first-of-type {
        flex-grow: 1;
    }

    .document-details {
        margin-top: 2px;
    }

    .preview-btn {
        text-decoration: none !important;
        margin-right: 5px;  /* Space between preview and delete buttons */
    }

    .highlight {
        background-color: #fff3cd;
        padding: 2px 0;
    }
    .highlight.current-match {
        background-color: #ffc107;
    }
    .custom-control-label {
        cursor: pointer;
        padding-top: 2px;
    }
    #prevMatch, #nextMatch {
        padding: 0.375rem 0.75rem;
    }
    #prevMatch:disabled, #nextMatch:disabled {
        opacity: 0.5;
    }
    #searchCount {
        min-width: 80px;
        text-align: center;
        background-color: #f8f9fa;
    }
    .search-box {
        position: sticky;
        top: 0;
        background: white;
        padding: 10px 0;
        z-index: 1;
        border-bottom: 1px solid #dee2e6;
    }
    .fa-chevron-down {
        transition: transform 0.2s ease-in-out;
        transform: rotate(-90deg); /* Default position pointing right */
    }

    .fa-chevron-down.collapsed {
        transform: rotate(-90deg); /* Collapsed state pointing right */
    }

    .fa-chevron-down:not(.collapsed) {
        transform: rotate(0deg); /* Expanded state pointing down */
    }
</style>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Store project ID for use in AJAX calls
    const projectId = {{ project.id }};
    
    // Project Details/Scoring Toggle
    $('#showDetails').on('click', function() {
        $(this).addClass('custom-teal').removeClass('btn-outline-teal');
        $('#showMetrics').removeClass('custom-teal').addClass('btn-outline-teal');
        $('#detailsCard').show();
        $('#metricsCard').hide();
    });

    $('#showMetrics').on('click', function() {
        $(this).addClass('custom-teal').removeClass('btn-outline-teal');
        $('#showDetails').removeClass('custom-teal').addClass('btn-outline-teal');
        $('#detailsCard').hide();
        $('#metricsCard').show();
    });

    // Initial state - Metrics shown by default
    $('#detailsCard').hide();
    $('#metricsCard').show();
    $('#showMetrics').addClass('custom-teal').removeClass('btn-outline-teal');
    $('#showDetails').removeClass('custom-teal').addClass('btn-outline-teal');
    
    // Handle collapse toggle and chevron rotation
    $('.btn[data-toggle="collapse"]').on('click', function(e) {
        // Remove Bootstrap's data-toggle attribute after the first initialization
        // This prevents Bootstrap from automatically handling the collapse
        $(this).removeAttr('data-toggle');
        
        const chevron = $(this).find('.fa-chevron-down');
        const targetId = $(this).data('target');
        const target = $(targetId);
        
        // Toggle the collapse manually
        if (target.hasClass('show')) {
            target.removeClass('show');
        } else {
            target.addClass('show');
        }
        
        // Toggle the chevron state
        chevron.toggleClass('collapsed');
    });

    // Expand/Collapse All function
    window.toggleAllResponses = function(expand) {
        const responses = $('.collapse');
        const chevrons = $('.fa-chevron-down');
        if (expand) {
            responses.collapse('show');
            chevrons.removeClass('collapsed');
        } else {
            responses.collapse('hide');
            chevrons.addClass('collapsed');
        }
    };

    // Document preview and search functionality
    let originalContent = '';
    let searchTimeout;
    let currentMatchIndex = -1;
    let matches = [];

    // Document preview click handler
    $('.preview-btn').on('click', function(e) {
        e.preventDefault();
        const documentId = $(this).data('document-id');
        const modal = $('#documentPreviewModal');
        const contentDiv = modal.find('.document-content');
        
        // Reset search
        $('#documentSearchInput').val('');
        $('#searchCount').text('0 matches');
        
        contentDiv.html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading document...</div>');
        modal.modal('show');
        
        $.ajax({
            url: `/projects/document/${documentId}/preview`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    modal.find('.modal-title').text(response.filename);
                    contentDiv.html(`<pre class="document-text">${response.content}</pre>`);
                    originalContent = response.content; // Store original content
                } else {
                    contentDiv.html(`<div class="alert alert-danger">${response.error}</div>`);
                }
            },
            error: function() {
                contentDiv.html('<div class="alert alert-danger">Error loading document content</div>');
            }
        });
    });

    // Search functionality
    function scrollToMatch(index) {
        if (matches.length === 0) return;
        
        currentMatchIndex = (index + matches.length) % matches.length;
        const marks = $('.document-content mark');
        
        if (marks[currentMatchIndex]) {
            marks.removeClass('current-match');
            $(marks[currentMatchIndex]).addClass('current-match');
            
            marks[currentMatchIndex].scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            
            $('#searchCount').text(`${currentMatchIndex + 1}/${matches.length} matches`);
        }
    }

    function performSearch() {
        const searchText = $('#documentSearchInput').val();
        const caseSensitive = $('#caseSensitive').prop('checked');
        
        if (!searchText || searchText.length < 2) {
            $('.document-content pre').html(originalContent);
            $('#searchCount').text('0 matches');
            $('#prevMatch, #nextMatch').prop('disabled', true);
            matches = [];
            currentMatchIndex = -1;
            return;
        }
        
        try {
            // Escape special regex characters
            const escapedSearchText = searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(escapedSearchText, caseSensitive ? 'g' : 'gi');
            matches = originalContent.match(regex) || [];
            
            // Highlight matches
            const highlightedContent = originalContent.replace(regex, match => 
                `<mark class="highlight">${match}</mark>`
            );
            
            $('.document-content pre').html(highlightedContent);
            
            if (matches.length > 0) {
                $('#searchCount').text(`1/${matches.length} matches`);
                $('#prevMatch, #nextMatch').prop('disabled', false);
                currentMatchIndex = 0;
                scrollToMatch(0);
            } else {
                $('#searchCount').text('No matches');
                $('#prevMatch, #nextMatch').prop('disabled', true);
                currentMatchIndex = -1;
            }
        } catch (e) {
            console.error('Search error:', e);
            $('#searchCount').text('Error');
            $('#prevMatch, #nextMatch').prop('disabled', true);
        }
    }

    // Search event handlers
    $('#documentSearchInput').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
    });

    $('#caseSensitive').on('change', performSearch);
    $('#prevMatch').on('click', () => scrollToMatch(currentMatchIndex - 1));
    $('#nextMatch').on('click', () => scrollToMatch(currentMatchIndex + 1));

    // Project edit form handlers
    let formChanged = false;
    const editForm = $('#projectEditForm form');

    editForm.find('input, textarea').on('change keyup paste', function() {
        formChanged = true;
    });

    editForm.on('submit', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: this.action,
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    formChanged = false;
                    // Reload the page to show updated data
                    window.location.reload();
                } else {
                    alert('Error updating project: ' + response.message);
                }
            },
            error: function() {
                alert('Error updating project. Please try again.');
            }
        });
    });

    $('.edit-details-btn').on('click', function() {
        $('#projectViewTable').hide();
        $('#projectEditForm').show();
    });

    $('.cancel-edit-btn').on('click', function() {
        if (formChanged && !confirm('You have unsaved changes. Are you sure you want to cancel?')) {
            return;
        }
        formChanged = false;
        $('#projectViewTable').show();
        $('#projectEditForm').hide();
    });

    // Project notes form handler
    $('#notesForm').on('submit', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: this.action,
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    // Show success message
                    const alertDiv = $('<div class="alert alert-success alert-dismissible fade show" role="alert">')
                        .text(response.message)
                        .append('<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>');
                    
                    $('#notesForm').before(alertDiv);
                    
                    // Remove alert after 3 seconds
                    setTimeout(function() {
                        alertDiv.alert('close');
                    }, 3000);
                } else {
                    alert('Error updating notes: ' + response.message);
                }
            },
            error: function() {
                alert('Error updating notes. Please try again.');
            }
        });
    });

    // Document deletion functions
    window.showDeleteConfirmation = function(filename, documentId) {
        $('#documentName').text(filename);
        $('#confirmDelete').off('click').on('click', function() {
            $(`#deleteForm-${documentId}`).submit();
        });
        $('#deleteConfirmationModal').modal('show');
    };

    window.showAssessmentDeleteConfirmation = function(date, assessmentId) {
        $('#assessmentDate').text(date);
        $('#confirmAssessmentDelete').off('click').on('click', function() {
            $(`#deleteAssessmentForm-${assessmentId}`).submit();
        });
        $('#deleteAssessmentModal').modal('show');
    };

    // Response editing functions
    window.startEdit = function(responseId) {
        $(`#responseText${responseId}`).hide();
        $(`#responseEditForm${responseId}`).show();
        $(`#editBtn${responseId}`).hide();
        $(`#reviewBtn${responseId}`).hide();
    };

    window.cancelEdit = function(responseId) {
        $(`#responseText${responseId}`).show();
        $(`#responseEditForm${responseId}`).hide();
        $(`#editBtn${responseId}`).show();
        $(`#reviewBtn${responseId}`).show();
    };

    window.saveEdit = function(responseId) {
        const newText = $(`#responseEditForm${responseId} textarea`).val();
        
        $.ajax({
            url: `/update_response/${responseId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                response_text: newText
            }),
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            success: function(response) {
                if (response.success) {
                    $(`#responseText${responseId}`).html(newText.replace(/\n/g, '<br>'));
                    cancelEdit(responseId);
                } else {
                    alert('Error saving changes: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Error saving changes. Please try again.');
            }
        });
    };

    window.markAsReviewed = function(event, responseId) {
        event.preventDefault();
        
        $.ajax({
            url: `/mark_response_reviewed/${responseId}`,
            method: 'POST',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error marking as reviewed: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Error marking as reviewed. Please try again.');
            }
        });
    };

    // Add this function to your existing script section
    window.unmarkAsReviewed = function(event, responseId) {
        event.preventDefault();
        
        $.ajax({
            url: `/unmark_response_reviewed/${responseId}`,
            method: 'POST',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}"
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error unmarking as reviewed: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Error unmarking as reviewed. Please try again.');
            }
        });
    };

    // Add form change tracking for metrics form
    let metricsFormChanged = false;
    const metricsForm = $('#metricsForm');

    metricsForm.find('input, select').on('change', function() {
        metricsFormChanged = true;
    });

    // Update metrics form handler to check for changes
    $('#metricsForm').on('submit', function(e) {
        e.preventDefault();
        
        // Convert numeric fields to proper decimal values before submitting
        $(this).find('input[type="number"]').each(function() {
            if ($(this).val()) {
                $(this).val(parseFloat($(this).val()));
            }
        });
        
        $.ajax({
            url: this.action,
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    metricsFormChanged = false;
                    const alertDiv = $('<div class="alert alert-success alert-dismissible fade show" role="alert">')
                        .text('Project scoring updated successfully')
                        .append('<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>');
                    
                    $('#metricsForm').before(alertDiv);
                    setTimeout(function() {
                        alertDiv.alert('close');
                    }, 3000);
                } else {
                    alert('Error updating project scoring: ' + response.message);
                }
            },
            error: function() {
                alert('Error updating project scoring. Please try again.');
            }
        });
    });

    // Add window beforeunload handler
    $(window).on('beforeunload', function(e) {
        if (metricsFormChanged || formChanged) {
            // For modern browsers
            e.preventDefault();
            // For older browsers
            return "You have unsaved changes. Are you sure you want to leave?";
        }
    });
});
</script>
{% endblock %} 