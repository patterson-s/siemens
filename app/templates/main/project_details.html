{% extends "base.html" %}

{% block content %}
    <h1 class="my-4">{{ project.name }}</h1>
    
    <div class="row">
        <div class="col-md-8">  <!-- Left column -->
            <!-- Documents card first -->
            <div class="card mb-3">  <!-- Documents card -->
                <div class="card-body">
                    <h5 class="card-title">Documents</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Uploaded Documents</h6>
                    <ul class="list-unstyled">
                        {% for document in project.documents %}
                            <li class="mb-2">
                                {% set file_ext = document.filename.split('.')[-1]|lower %}
                                {% if file_ext == 'pdf' %}
                                    <i class="fas fa-file-pdf text-danger"></i>
                                {% elif file_ext in ['doc', 'docx'] %}
                                    <i class="fas fa-file-word text-primary"></i>
                                {% elif file_ext == 'txt' %}
                                    <i class="fas fa-file-alt text-secondary"></i>
                                {% else %}
                                    <i class="fas fa-file text-secondary"></i>
                                {% endif %}
                                <span class="ml-2">{{ document.filename }}</span>
                                <span class="text-muted">({{ document.document_type|replace('_', ' ')|title }})</span>
                                <form action="{{ url_for('main.delete_document', project_id=project.id, document_id=document.id) }}" 
                                      method="POST" style="display:inline;" id="deleteForm-{{ document.id }}">
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="showDeleteConfirmation('{{ document.filename }}', {{ document.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </li>
                        {% else %}
                            <li><i class="fas fa-info-circle text-info"></i> No documents uploaded yet.</li>
                        {% endfor %}
                    </ul>
                    <a href="{{ url_for('main.upload_document', project_id=project.id) }}" class="btn btn-primary">Upload Document</a>
                </div>
            </div>

            <!-- Question Responses card second -->
            <div class="card mb-3">
                <div class="card-header custom-teal d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Question Responses</h5>
                    <div>
                        <button class="btn btn-sm btn-header-action mr-2" onclick="toggleAllResponses(true)">
                            <i class="fas fa-expand-alt"></i> Expand All
                        </button>
                        <button class="btn btn-sm btn-header-action" onclick="toggleAllResponses(false)">
                            <i class="fas fa-compress-alt"></i> Collapse All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Question Responses section -->
                    {% if latest_responses %}
                        {% for response in latest_responses|sort(attribute='question.order') %}
                            <div class="mb-3">
                                <!-- Question header -->
                                <div class="btn btn-outline-teal text-left w-100 d-flex justify-content-between align-items-center" 
                                     data-toggle="collapse" 
                                     data-target="#response{{ response.id }}" 
                                     style="cursor: pointer;">
                                    <!-- Question title -->
                                    <span class="text-truncate" style="max-width: 70%;">{{ response.question.name }}</span>
                                    
                                    <!-- Review status and expand icon -->
                                    <span>
                                        {% if response.reviewed %}
                                            <span class="badge badge-success mr-2" style="min-width: 100px;">Reviewed</span>
                                        {% else %}
                                            <span class="badge badge-outline-info mr-2" style="min-width: 100px;">Not Reviewed</span>
                                        {% endif %}
                                        <i class="fas fa-chevron-down"></i>
                                    </span>
                                </div>

                                <!-- Response content -->
                                <div class="collapse" id="response{{ response.id }}">
                                    <div class="card card-body mt-2 border-left border-teal">
                                        <!-- Response text container -->
                                        <div id="responseText{{ response.id }}" class="response-text">
                                            {{ response.response_text|nl2br|safe }}
                                        </div>
                                        
                                        <!-- Edit form (hidden by default) -->
                                        <div id="responseEditForm{{ response.id }}" class="response-edit-form" style="display: none;">
                                            <textarea class="form-control mb-2" rows="5">{{ response.response_text }}</textarea>
                                            <div class="text-right">
                                                <button class="btn btn-sm btn-secondary mr-2" onclick="cancelEdit({{ response.id }})">Cancel</button>
                                                <button class="btn btn-sm btn-success" onclick="saveEdit({{ response.id }})">Save Changes</button>
                                            </div>
                                        </div>

                                        {% if not response.reviewed %}
                                            <div class="text-right mt-3">
                                                <button class="btn btn-sm btn-outline-secondary mr-2" 
                                                        onclick="startEdit({{ response.id }})"
                                                        id="editBtn{{ response.id }}">
                                                    <i class="fas fa-edit mr-1"></i>Edit Response
                                                </button>
                                                <button class="btn btn-sm btn-primary" 
                                                        onclick="markAsReviewed(event, {{ response.id }})"
                                                        id="reviewBtn{{ response.id }}">
                                                    <i class="fas fa-check mr-1"></i>Mark as Reviewed
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No responses available.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Assessments card last -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Generate Responses</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Previous Generate Response Runs</h6>
                    <ul class="list-unstyled">
                        {% for evaluation in project.evaluation_runs|sort(attribute='created_at', reverse=True) %}
                            <li class="mb-3">  <!-- Increased margin bottom -->
                                <div class="d-flex justify-content-between align-items-center">  <!-- Flex container -->
                                    <div>  <!-- Left side with date and model info -->
                                        {% set adjusted_time = evaluation.created_at.replace(
                                            hour=(evaluation.created_at.hour - 4) % 24,
                                            day=evaluation.created_at.day - 1 if evaluation.created_at.hour < 4 else evaluation.created_at.day
                                        ) %}
                                        {{ adjusted_time.strftime('%b %d, %Y %H:%M') }} EDT
                                        using {{ evaluation.model_used|replace('claude-', 'Claude ')|replace('-latest', '')|replace('-', '.')|title }}
                                        ({{ evaluation.responses|length }} questions)
                                    </div>
                                    <div>  <!-- Right side with buttons -->
                                        <a href="{{ url_for('main.view_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                           class="btn btn-primary btn-sm">View Responses</a>
                                        <form action="{{ url_for('main.delete_assessment', project_id=project.id, evaluation_id=evaluation.id) }}" 
                                              method="POST" style="display:inline;" id="deleteAssessmentForm-{{ evaluation.id }}">
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="showAssessmentDeleteConfirmation('{{ adjusted_time.strftime('%b %d, %Y %H:%M') }}', {{ evaluation.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </li>
                        {% else %}
                            <li>No responses generated yet.</li>
                        {% endfor %}
                    </ul>
                    <div class="mt-3">  <!-- Added margin top -->
                        <a href="{{ url_for('main.start_assessment', project_id=project.id) }}" 
                           class="btn btn-primary">Generate New Responses </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">  <!-- Right column for project details -->
            <div class="card mb-3">  <!-- Project Details card -->
                <div class="card-body">
                    <h5 class="card-title">Project Details</h5>
                    
                    <!-- View-only table -->
                    <table class="table table-sm" id="projectViewTable">
                        <tbody>
                            <tr>
                                <th>Funding Round</th>
                                <td>
                                    {% if project.name_of_round == 1.0 %}
                                        First Round
                                    {% elif project.name_of_round == 2.0 %}
                                        Second Round
                                    {% elif project.name_of_round == 3.0 %}
                                        Third Round
                                    {% else %}
                                        Round {{ project.name_of_round }}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>File Number</th>
                                <td>{{ project.file_number_db }}</td>
                            </tr>
                            <tr>
                                <th>Scope</th>
                                <td>{{ project.scope }}</td>
                            </tr>
                            <tr>
                                <th>Region</th>
                                <td>{{ project.region }}</td>
                            </tr>
                            <tr>
                                <th>Countries</th>
                                <td>{{ project.countries_covered }}</td>
                            </tr>
                            <tr>
                                <th>Partner Name</th>
                                <td>{{ project.integrity_partner_name }}</td>
                            </tr>
                            <tr>
                                <th>Partner Type</th>
                                <td>{{ project.partner_type }}</td>
                            </tr>
                            <tr>
                                <th>Project Partners</th>
                                <td>{{ project.project_partners }}</td>
                            </tr>
                            <tr>
                                <th>WB/EIB</th>
                                <td>{{ project.wb_or_eib }}</td>
                            </tr>
                            <tr>
                                <th>Objectives</th>
                                <td>{{ project.key_project_objectives }}</td>
                            </tr>
                            <tr>
                                <th>Sectoral Scope</th>
                                <td>{{ project.sectoral_scope }}</td>
                            </tr>
                            <tr>
                                <th>Specific Sector</th>
                                <td>{{ project.specific_sector }}</td>
                            </tr>
                            <tr>
                                <th>Funding (USD)</th>
                                <td>
                                    {% if project.funding_amount_usd %}
                                        ${{ "{:,.1f}".format(project.funding_amount_usd) }} million
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Duration</th>
                                <td>{{ project.duration }}</td>
                            </tr>
                            <tr>
                                <th>Years</th>
                                <td>{{ project.start_year }} - {{ project.end_year }}</td>
                            </tr>
                            <tr>
                                <th>WB Income Class</th>
                                <td>{{ project.wb_income_classification }}</td>
                            </tr>
                            <tr>
                                <th>Corruption Quintile</th>
                                <td>{{ project.corruption_quintile or '' }}</td>
                            </tr>
                            <tr>
                                <th>CCI</th>
                                <td>{{ "%.2f"|format(project.cci|float) if project.cci }}</td>
                            </tr>
                            <tr>
                                <th>Gov Type (EIU)</th>
                                <td>{{ project.government_type_eiu }}</td>
                            </tr>
                            <tr>
                                <th>Gov Score (EIU)</th>
                                <td>{{ "%.2f"|format(project.government_score_eiu|float) if project.government_score_eiu }}</td>
                            </tr>
                            <tr>
                                <th>Documents Available</th>
                                <td>
                                    {% if project.final_external_evaluation %}Final Evaluation<br>{% endif %}
                                    {% if project.final_report %}Final Report<br>{% endif %}
                                    {% if project.full_proposal %}Full Proposal<br>{% endif %}
                                    {% if project.workplan %}Workplan<br>{% endif %}
                                    {% if project.baseline_assessment %}Baseline Assessment{% endif %}
                                </td>
                            </tr>
                            {% if project.other %}
                            <tr>
                                <th>Other</th>
                                <td>{{ project.other }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td colspan="2" class="text-right">
                                    <button type="button" class="btn btn-primary btn-sm edit-details-btn">Edit Details</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notes card moved here -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Project Notes</h5>
                    <form id="notesForm" method="POST" action="{{ url_for('main.update_notes', project_id=project.id) }}">
                        <div class="form-group">
                            <textarea class="form-control" id="notes" name="notes" rows="4">{{ project.notes or '' }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Notes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Document Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the document:</p>
                    <p class="font-weight-bold" id="documentName"></p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete Document</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Delete Confirmation Modal -->
    <div class="modal fade" id="deleteAssessmentModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Assessment Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the assessment from:</p>
                    <p class="font-weight-bold" id="assessmentDate"></p>
                    <p class="text-danger">This action cannot be undone and will delete all responses associated with this assessment.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmAssessmentDelete">Delete Assessment</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Project details scripts loaded');
        
        // Add form submit handler
        const projectEditForm = document.getElementById('projectEditForm');
        if (projectEditForm) {
            projectEditForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submit triggered');
                
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error updating project: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating project. Please try again.');
                });
            });
        }

        // Add notes form submit handler
        const notesForm = document.getElementById('notesForm');
        if (notesForm) {
            notesForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                        alert.innerHTML = `
                            Notes updated successfully
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&times;</span>
                            </button>
                        `;
                        notesForm.appendChild(alert);
                        setTimeout(() => alert.remove(), 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger alert-dismissible fade show mt-2';
                    alert.innerHTML = `
                        Error updating notes. Please try again.
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    `;
                    notesForm.appendChild(alert);
                });
            });
        }
    });

    // Toggle function for edit mode
    function testToggle() {
        console.log('Toggle called');  // Debug log
        var viewTable = document.getElementById('projectViewTable');
        var editForm = document.getElementById('projectEditForm');
        
        console.log('Current display states:', {  // Debug log
            viewTable: viewTable ? viewTable.style.display : 'element not found',
            editForm: editForm ? editForm.style.display : 'element not found'
        });
        
        if (viewTable && editForm) {
            if (editForm.style.display === 'none' || editForm.style.display === '') {
                viewTable.style.display = 'none';
                editForm.style.display = 'block';
                console.log('Switched to edit mode');  // Debug log
            } else {
                viewTable.style.display = 'table';
                editForm.style.display = 'none';
                console.log('Switched to view mode');  // Debug log
            }
        } else {
            console.error('Required elements not found:', {  // Debug log
                viewTable: !!viewTable,
                editForm: !!editForm
            });
        }
    }

    // Document deletion functions
    function showDeleteConfirmation(filename, documentId) {
        document.getElementById('documentName').textContent = filename;
        document.getElementById('confirmDelete').onclick = function() {
            document.getElementById('deleteForm-' + documentId).submit();
        };
        $('#deleteConfirmationModal').modal('show');
    }

    function showAssessmentDeleteConfirmation(date, assessmentId) {
        document.getElementById('assessmentDate').textContent = date;
        document.getElementById('confirmAssessmentDelete').onclick = function() {
            document.getElementById('deleteAssessmentForm-' + assessmentId).submit();
        };
        $('#deleteAssessmentModal').modal('show');
    }

    function toggleAllResponses(expand) {
        const collapseElements = document.querySelectorAll('[id^="response"]');
        collapseElements.forEach(element => {
            if (expand) {
                $(element).collapse('show');
            } else {
                $(element).collapse('hide');
            }
        });
    }

    function markAsReviewed(event, responseId) {
        event.preventDefault();
        event.stopPropagation();
        
        fetch(`/mark_response_reviewed/${responseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                try {
                    // Find the container div for this response
                    const responseContainer = document.querySelector(`#response${responseId}`);
                    if (!responseContainer) {
                        throw new Error('Response container not found');
                    }
                    
                    // Update the badge in the header
                    const statusBadge = responseContainer.parentElement.querySelector('.badge-outline-info');
                    if (statusBadge) {
                        statusBadge.className = 'badge badge-success mr-2';
                        statusBadge.textContent = 'Reviewed';
                    }
                    
                    // Remove the "Mark as Reviewed" button container
                    const buttonContainer = responseContainer.querySelector('.text-right');
                    if (buttonContainer) {
                        buttonContainer.remove();
                    }

                    // Collapse the response div
                    $(responseContainer).collapse('hide');
                    
                } catch (err) {
                    console.error('DOM update error:', err);
                    window.location.reload();
                }
            } else {
                throw new Error('Server returned failure');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating review status. Please try again.');
        });
    }

    function startEdit(responseId) {
        // Hide response text and show edit form
        $(`#responseText${responseId}`).hide();
        $(`#responseEditForm${responseId}`).show();
        
        // Disable the Mark as Reviewed button
        $(`#reviewBtn${responseId}`).prop('disabled', true);
        $(`#editBtn${responseId}`).prop('disabled', true);
    }

    function cancelEdit(responseId) {
        // Hide edit form and show response text
        $(`#responseEditForm${responseId}`).hide();
        $(`#responseText${responseId}`).show();
        
        // Re-enable the buttons
        $(`#reviewBtn${responseId}`).prop('disabled', false);
        $(`#editBtn${responseId}`).prop('disabled', false);
    }

    function saveEdit(responseId) {
        const newText = $(`#responseEditForm${responseId} textarea`).val();
        
        fetch(`/update_response/${responseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ response_text: newText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the displayed text
                $(`#responseText${responseId}`).html(newText.replace(/\n/g, '<br>'));
                
                // Hide edit form and show response text
                $(`#responseEditForm${responseId}`).hide();
                $(`#responseText${responseId}`).show();
                
                // Re-enable the buttons
                $(`#reviewBtn${responseId}`).prop('disabled', false);
                $(`#editBtn${responseId}`).prop('disabled', false);
            } else {
                throw new Error('Failed to save changes');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving changes. Please try again.');
        });
    }
    </script>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Document ready fired');
    
    // Bind click handler directly to button
    $('.edit-details-btn').on('click', function() {
        console.log('Edit button clicked');
        $('#projectViewTable').hide();
        $('#projectEditForm').show();
    });
    
    // Bind click handler to cancel button
    $('.cancel-edit-btn').on('click', function() {
        console.log('Cancel button clicked');
        $('#projectViewTable').show();
        $('#projectEditForm').hide();
    });
});
</script>
{% endblock %}

<style>
    .custom-teal {
        background-color: #1abc9c !important;
        border-color: #1abc9c !important;
        color: white !important;
    }
    .btn-outline-teal {
        color: #1abc9c !important;
        border: 1px solid #1abc9c !important;
        background-color: white !important;
        padding: 0.25rem 0.5rem !important;
        font-size: 0.875rem !important;
    }
    .btn-outline-teal:hover {
        color: white !important;
        background-color: #1abc9c !important;
    }
    .border-teal {
        border-color: #1abc9c !important;
    }
    .btn-header-action {
        color: white !important;
        border: 1px solid white !important;
        background: transparent !important;
    }
    .btn-header-action:hover {
        background: rgba(255, 255, 255, 0.2) !important;
    }
    .btn-teal {
        background-color: #1abc9c !important;
        border: 1px solid #1abc9c !important;
        color: white !important;
        padding: 0.25rem 0.5rem !important;
        font-size: 0.875rem !important;
    }
    .btn-outline-teal.review-toggle {
        display: none;
    }
    .badge {
        padding: 0.4rem 0.6rem !important;
        font-weight: 400 !important;
        font-size: 0.875rem !important;
        text-transform: none !important;
    }
    
    .badge.badge-outline-info,
    .badge-outline-info {
        color: #1abc9c !important;
        background-color: white !important;
        border: 1px solid #1abc9c !important;
        font-weight: 400 !important;
    }
    
    .badge.badge-success,
    .badge-success {
        background-color: #28a745 !important;
        color: white !important;
        font-weight: 400 !important;
    }
</style> 